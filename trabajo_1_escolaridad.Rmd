---
title: "Trabajo 1 TAE - Salud"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Librerías

```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(data.table)
library(readxl)
library(GGally)
library(leaflet)
library(raster)
```

# Algunas funciones necesarias

## Función para la moda

```{r}
# Función para la moda
getmode <- function(v, na.rm = TRUE) {
  if(na.rm == TRUE) {
    v <- v[!is.na(v)]
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
   } else {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
  }
}
```


# Lectura de datos

```{r}
raw_encuesta <- fread("databases/calidad_vida_ok.csv", encoding = "UTF-8") %>% 
  as_tibble()

raw_encuesta$encuesta_calidad.barrio <- raw_encuesta$encuesta_calidad.barrio %>% 
  str_replace_all("CIUDADE LA NUEVO OCCIDENTE", "CABECERA SAN CRISTÓBAL")

raw_encuesta$encuesta_calidad.barrio <- raw_encuesta$encuesta_calidad.barrio %>% 
  str_replace_all("CABECERA ALTAVISTA", "ALTAVISTA") 

raw_encuesta$encuesta_calidad.barrio <- raw_encuesta$encuesta_calidad.barrio %>% str_replace_all("PROGRESO  Nº 2", "PROGRESO") %>% unique() %>% sort()

gsub("PROGRESO  Nº 2", "PROGRESO", raw_encuesta$encuesta_calidad.barrio) %>% unique() %>% sort()

str_replace_all(raw_encuesta$encuesta_calidad.barrio, "PROGRESO  Nº 2", "PROGRESO") %>% unique() %>% sort()
  
```

# Creación de la base de datos
```{r}
db_escolaridad <- raw_encuesta %>% 
  group_by(encuesta_calidad.barrio) %>% 
  summarize(n = n(),
            edad_promedio = mean(`encuesta_calidad.p_18`, na.rm = TRUE),
            proporcion_lectoescritura = sum(`encuesta_calidad.p_35` == 1, na.rm = TRUE) / sum(!is.na(`encuesta_calidad.p_35`), na.rm = TRUE),
            proporcion_escolaridad_actual = sum(`encuesta_calidad.p_36` == 1, na.rm = TRUE) / sum(!is.na(`encuesta_calidad.p_36`), na.rm = TRUE),
            estudio_ultimo_ano = sum(`encuesta_calidad.p_37` == 1, na.rm = TRUE) / sum(!is.na(`encuesta_calidad.p_37`), na.rm = TRUE),
            ultimo_nivel_estudio = getmode(`encuesta_calidad.p_45`, na.rm = TRUE),
            tipo_institucion_educativa = getmode(`encuesta_calidad.p_49`, na.rm = TRUE)
          ) %>% as.data.frame()

db_escolaridad <- db_escolaridad %>% mutate(
  ultimo_nivel_estudio = as.factor(ultimo_nivel_estudio),
  tipo_institucion_educativa = as.factor(tipo_institucion_educativa)
)

rownames(db_escolaridad) <- db_escolaridad[, 1]
db_escolaridad[, 1] <- NULL


rownames(db_escolaridad) <- rownames(db_escolaridad) %>% 
  str_replace("ANDALUCIA", "ANDALUCÍA") %>% 
  str_replace("Nº 2", "NO.2") %>% 
  str_replace("Nº 1", "NO.1") %>% 
  str_replace("Nº 3", "NO.3") %>%
  str_replace("AREA EXPANSION", "ÁREA DE EXPANSIÓN") %>% 
  str_replace("DELA", "DE LA") %>% 
  str_replace("EXPANCION", "EXPANSIÓN") %>% 
  str_replace("AREA", "ÁREA") %>% 
  str_replace("CRISTOBAL", "CRISTÓBAL") %>% 
  str_replace("BOMBONA", "BOMBONÁ") %>% 
  str_replace("LA ASOMADERA", "ASOMADERA") %>%
  str_replace("BELALCAZAR", "BELALCÁZAR") %>% 
  str_replace("CALAZANS", "CALASANZ") %>% 
  str_replace("COLON", "COLÓN") %>% 
  str_replace("MIRA FLORES", "MIRAFLORES") %>% 
  str_replace("BARRIO FACULTAD DE MINAS", "FACULTAD DE MINAS") %>% 
  str_replace("CABECERA SAN ANT DE PR.", "SAN ANTONIO DE PRADO") %>% 
  str_replace("CARLOS E RESTREPO", "CARLOS E. RESTREPO") %>% 
  str_replace("URQUITA", "URQUITÁ") %>% 
  str_replace("LOS CERROS EL VERJEL", "LOS CERROS EL VERGEL") %>% 
  str_replace("CAYCEDO", "CAICEDO") %>% 
  str_replace("VALDES", "VALDÉS") %>% 
  str_replace("CERRO EL VOLADOR", "B. CERRO EL VOLADOR") %>% 
  str_replace("MOSCU", "MOSCÚ") %>% 
  str_replace("JOSELA", "JOSÉ LA") %>%
  str_replace("JOSE", "JOSÉ") %>% 
  str_replace("EL YOLOMBO", "YOLOMBO") %>% 
  str_replace("PIEDRAS BLANCAS", "PIEDRAS BLANCAS - MATASANO") %>% 
  str_replace("BASILIA", "BRASILIA") %>% 
  str_replace("VILLA TINA", "VILLATINA") %>% 
  str_replace("LILIAM", "LILLIAM") %>% 
  str_replace("BOLIVAR", "BOLÍVAR") %>% 
  str_replace("CORREGIMIENTO PALMITAS", "PALMITAS SECTOR CENTRAL") %>% 
  str_replace("INES", "INÉS") %>% 
  str_replace("FE", "FÉ") %>% 
  str_replace("LUCIA", "LUCÍA") %>% 
  str_replace("SABIO", "SAVIO") %>% 
  str_replace("BERMEJAL- LOS ÁLAMOS", "BERMEJAL-LOS ÁLAMOS") %>% 
  str_replace("BOLÍVARIANA", "BOLIVARIANA") %>% 
  str_replace("EL NOGAL - LOS ALMENDROS", "EL NOGAL-LOS ALMENDROS") %>% 
  str_replace("JUAN XXIII - LA QUIEBRA", "JUAN XXIII LA QUIEBRA") %>% 
  str_replace("PROGRESO  Nº 2", "EL PROGRESO") %>% 
  str_replace("MARIA", "MARÍA") %>% 
  str_replace("PLAYÓN", "PLAYON") %>% 
  str_replace("EL SOCORRO / LA GABRIELA", "EL SOCORRO") %>% 
  str_replace("FÉRRINI", "FERRINI") %>% 
  str_replace("LA CANDE LARIA", "LA CANDELARIA") %>%
  str_replace("EL PLAYON", "PLAYÓN") %>%
  str_replace("IGUANA", "IGUANÁ") %>%
  str_replace("MARÍA CANO - CARAMBOLAS", "MARÍA CANO-CARAMBOLAS") %>%
  str_replace("DE ABURRA", "DEL ABURRÁ") %>%
  str_replace("CABECERA SAN CRISTÓBAL", "CABECERA URBANA CORREGIMIENTO SAN CRISTÓBAL") %>%
  str_replace("ALTAVISTA CENTRAL", "ALTAVISTA SECTOR CENTRAL") %>%
  str_replace("SECTOR CENTRAL", "CENTRO ADMINISTRATIVO") %>%
  str_replace("ALTAVISTA CENTRO ADMINISTRATIVO", "ALTAVISTA SECTOR CENTRAL") %>%
  str_replace("SANTA ELENA CENTRO ADMINISTRATIVO", "SANTA ELENA SECTOR CENTRAL") %>%
  str_replace("PALMITAS CENTRO ADMINISTRATIVO", "PALMITAS SECTOR CENTRAL") %>% 
  str_replace("BELALCAZAR", "BELALCÁZAR") %>% 
  str_replace("BELALCAZAR", "BELALCÁZAR") %>% 
  str_replace("BELALCAZAR", "BELALCÁZAR")

    
```




# Escritura de los datos

```{r}
write_excel_csv2(db_escolaridad, "databases/db_escolaridad.csv")
```

# Descripcion de las variables seleccionadas

* **edad_promedio:** se calcula como el promedio de los años cumplidos de los encuestados calculando dicho promedio para cada barrio.
* **proporcion_lectoescritura:** esta variable se construye a partir de la pregunta 35. La variable se calcula como la proporción de personas que pueden leer y escribir más de un parrafo con respecto al total de personas que respondieron dicha pregunta. Esta proporción se calcula a nivel de cada barrio.
* **proporcion_escolaridad_actual:** esta variable es un derivado de la pregunta 36. Esta variable representa la proporción de personas que están estudiando en el momento respecto al total de personas que respondieron esta pregunta para cada barrio.
* **esudio_ultimo_ano:** Se calcula como la proporción de personas que estudian en el ultimo año respecto al total de personas que respondieron la pregunta 37 de manera efectiva.
* **ultimo_nivel_estudio:** representa la moda de cada barrio extraida sobre el nivel de estudio de los hogares encuestados. Esta pregunta es extraída mediante el cálculo de la moda sobre la pregunta 45.
* **tipo_institucion_educativa**: se extrae mediante el calculo de la moda de cada barrio a sobre la pregunta 49. Representa el tipo de institución educativa que predominante en la cuál los encuestados estudiaron su último curso o en la que están estudiando actualmente.

Es importante considerar que la variable "edad_promedio" no necesariamente hace referencia a la dimensión de escolaridad, sin embargo, se quiere realizar un contraste entre la variable "edad_promedio" y las demás variables para extraer información y hacer validaciones empíricas.

# Analisis preliminar de los datos

## Medias, cuartiles y desviaciones estándar

```{r}
summary(db_escolaridad)
```

#### Desviaciones estándar

``` {r}
db_escolaridad %>% select_if(is.numeric) %>% 
  apply(2, sd)
```

Dada la información sobre las medias arrojada para cada variable, hay que resaltar que la proporción de personas con habilidades lecto-escritoras es alta con un `r mean(db_escolaridad$proporcion_lectoescritura)`, la cual es una cifra positiva pues muestra que en la población no hay analfabetismo crítico.

Por otro lado, las proporción de personas que estudiaron en el último año tambien es baja, pero no se debe concluir que esto es necesariamente negativo. Cabe la posibilidad que varias personas en un determinado barrio sean trabajadores y por tanto no dedican mas tiempo al estudio a partir de cierto momento de su vida.

Por otro lado, note que al extraer el último nivel de estudio aprobado predominante en cada barrio, se encuentra que las clases mas representativas corresponden a Media Académica o Normalista y a Educación Primaria. Sin embargo, los estudios universitarios son predominantes en `r  db_escolaridad %>% filter(ultimo_nivel_estudio == 7) %>% count()` de los `r nrow(db_escolaridad)` barrios, sin embargo esto sigue siendo una minoría dentro de la población de la ciudad.

# Graficas

## Correlaciones y análisis de distribuciones

```{r}
ggpairs(data = db_escolaridad, columns = 1:ncol(db_escolaridad))
```

De la gráfica anterior, se debe resaltar significativamente las correlaciones entre las variables "edad_promedio" con las variables "proporcion_lectoescritura" y "proporcion_escolaridad_actual". Note que la "edad_promedio" esta correlacionada de manera directa con la variable "proporcion_lectoescritura" y de manera inversa con la variable "proporcion_escolaridad_actual". Esta información que se obtiene coincide con el conocimiento epírico, pues por un lado, las personas con mayor edad tienen mas probabilidad de tener como mínimo una educación primaria, obteniendo así mas habilidades lecto-escritoras, mientras que por otro lado a medida que las personas envejecen dejan de educarse y pasan a ambientes mas laborales.

Por otro lado, note que en los barrios las personas tienen tendencia a educarse en establecimientos de índole pública debido a su fácil acceso.


## Valores tipicos

```{r}
ggplot(data = db_escolaridad) +
  geom_histogram(mapping = aes(x = proporcion_lectoescritura), binwidth = 0.002)
```

```{r}
ggplot(data = db_escolaridad,
       mapping = aes(x = proporcion_escolaridad_actual)) +
  geom_histogram(binwidth = 0.002)
```

```{r}
ggplot(data = db_escolaridad,
       mapping = aes(x = estudio_ultimo_ano)) +
  geom_histogram(binwidth = 0.0005)
```

```{r}
ggplot(data = db_escolaridad) +
  geom_histogram(mapping = aes(x = edad_promedio)) +
  facet_grid(rows = vars(ultimo_nivel_estudio))
```

# Escalamiento de datos numéricos

```{r}
db_escolaridad_escalado<- data.frame(
  scale(db_escolaridad %>% select_if(is.numeric)),
  db_escolaridad %>% select_if(negate(is.numeric))
)
```

# Aplicación de PCA

# Agrupamiento Jerárquico OJOOOOOOOOO CORREGIR METRICA CATEGORICA

```{r}
cantidad_grupos <- 7

distancia_numerico <- dist(db_escolaridad %>% select_if(is.numeric))
distancia_categorico <- dist(db_escolaridad %>% select_if(negate(is.numeric)))

distancia_consolidada <- distancia_numerico + distancia_categorico

agrupamiento <- hclust(distancia_consolidada, method = "complete")

arbol_corte <- cutree(agrupamiento, k = cantidad_grupos)


split_db_escolaridad <- split(db_escolaridad, arbol_corte)

```

# Seleccion de los grupos

```{r}
summary(split_db_escolaridad$`1`)
summary(split_db_escolaridad$`6`)
```

# Mapa de agrupamiento 

```{r}
political <- shapefile("Barrio_Vereda/Barrio_Vereda.shp")

Encoding(political@data$NOMBRE) <- "UTF-8"
political$NOMBRE <- political$NOMBRE %>% toupper() %>% str_replace("DE  MESA", "DE MESA")

leaflet(data = political) %>% 
  addTiles() %>% 
  addProviderTiles(providers$OpenStreetMap) %>% 
  addPolygons(fill = TRUE, stroke = TRUE, weight = 2, color = "#03F", 
              label = as.character(political$NOMBRE),
              popup = as.character(political$NOMBRE)) %>% 
  addLegend("bottomright", colors = "#03F", labels = "Barrios y veredas")
```

```{r}
nombres_mapa <- political$NOMBRE %>% sort()

interseccion <- nombres_mapa %>% 
  intersect(rownames(db_escolaridad))

no_coinciden <- rownames(db_escolaridad)[!(rownames(db_escolaridad) %in% interseccion)]
```

```{r}
no_coinciden
```

```{r}
rownames(db_escolaridad)
```

```{r}
agrupamiento <- raw_encuesta %>% 
  group_by(encuesta_calidad.barrio) %>% 
  summarise(n = n())

agrupamiento$encuesta_calidad.barrio
```





