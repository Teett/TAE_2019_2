---
title: "Trabajo 1 TAE - Salud"
author: "Nuestro equipo"
date: "12/2/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Librerías

```{r, warnings = F}
library(tidyverse)
library(data.table)
library(readxl)
library(GGally)
library(corrplot)
library(leaflet)
library(raster)
```

# Lectura de datos

```{r}
raw_encuesta <- fread("databases/calidad_vida_ok.csv", encoding = "UTF-8") %>% 
  as_tibble() %>% mutate(
  encuesta_calidad.barrio = case_when(
    encuesta_calidad.barrio == "CABECERA ALTAVISTA" ~ "ALTAVISTA",
    encuesta_calidad.barrio == "CIUDADELA NUEVO OCCIDENTE" ~ "CABECERA URBANA CORREGIMIENTO SAN CRISTÓBAL",
    encuesta_calidad.barrio == "AREA DE EXPANCION SAN CRISTOBAL" ~ "ÁREA DE EXPANSIÓN SAN CRISTÓBAL",
    encuesta_calidad.barrio == "CABECERA SAN CRISTÓBAL" ~ "CABECERA URBANA CORREGIMIENTO SAN CRISTÓBAL",
    encuesta_calidad.barrio == "SAN CRISTOBAL" ~ "CABECERA URBANA CORREGIMIENTO SAN CRISTÓBAL",
    encuesta_calidad.barrio == "PROGRESO  Nº 2" ~ "PROGRESO",
    TRUE ~ encuesta_calidad.barrio
  )
)

```

# Número de encuestados por barrio

```{r}
raw_encuesta %>% 
  count(`encuesta_calidad.barrio`, sort = T) %>% 
  arrange(n)
```

# Podríamos necesitar imputar datos

```{r}
raw_encuesta %>% 
  group_by(encuesta_calidad.barrio) %>% 
  summarize(usables = sum(!is.na(`encuesta_calidad.p_341`))) %>%
  arrange(usables)

# Ver Summary
raw_encuesta %>% select(`encuesta_calidad.p_341`) %>% summary()
```

Parece que será necesario imputar datos en algunos casos ya que hay muchos barrios importantes mal representados en este tipo de pregunta.

## Creación de la base de datos

# Discapacidad 

Con base en la cantidad de dos, se concluye que éste está asociado al "No", dado que se espera, en general, que el número de personas discapacitadas sea considerablemente menor al de no discapacitadas.

```{r}
raw_encuesta %>% 
select(paste0("encuesta_calidad.p_", 50:57)) %>%
  mutate_all(as_factor) %>% 
  summary()

preguntas_categoricas <- c("encuesta_calidad.p_266", "encuesta_calidad.p_326", "encuesta_calidad.p_329", "encuesta_calidad.p_332", 
                           "encuesta_calidad.p_335", "encuesta_calidad.p_338", "encuesta_calidad.p_341")
```

# Limpieza de los datos

```{r}
encuesta_salud <- raw_encuesta %>% 
  mutate(discapacidad = case_when(encuesta_calidad.p_50 == 1 ~ 1,
                                  encuesta_calidad.p_51 == 1 ~ 1,
                                  encuesta_calidad.p_52 == 1 ~ 1,
                                  encuesta_calidad.p_53 == 1 ~ 1,
                                  encuesta_calidad.p_54 == 1 ~ 1,
                                  encuesta_calidad.p_55 == 1 ~ 1,
                                  encuesta_calidad.p_56 == 1 ~ 1,
                                  encuesta_calidad.p_57 == 1 ~ 1,
                                  TRUE ~ 0)) %>% 
  mutate_at(vars(preguntas_categoricas), as_factor) %>%
  fastDummies::dummy_cols(remove_selected_columns = TRUE, select_columns = preguntas_categoricas) %>% 
  mutate(encuesta_calidad.barrio = str_replace(encuesta_calidad.barrio, "ANDALUCIA", "ANDALUCÍA") %>% 
  str_replace("Nº 2", "NO.2") %>% 
  str_replace("Nº 1", "NO.1") %>% 
  str_replace("Nº 3", "NO.3") %>%
  str_replace("AREA EXPANSION", "ÁREA DE EXPANSIÓN") %>%
  str_replace("EXPANCION", "EXPANSIÓN") %>% 
  str_replace("AREA", "ÁREA") %>% 
  str_replace("BOMBONA", "BOMBONÁ") %>% 
  str_replace("LA ASOMADERA", "ASOMADERA") %>%
  str_replace("BELALCAZAR", "BELALCÁZAR") %>% 
  str_replace("CALAZANS", "CALASANZ") %>% 
  str_replace("COLON", "COLÓN") %>% 
  str_replace("MIRA FLORES", "MIRAFLORES") %>% 
  str_replace("BARRIO FACULTAD DE MINAS", "FACULTAD DE MINAS") %>% 
  str_replace("CABECERA SAN ANT DE PR.", "SAN ANTONIO DE PRADO") %>% 
  str_replace("CARLOS E RESTREPO", "CARLOS E. RESTREPO") %>% 
  str_replace("URQUITA", "URQUITÁ") %>% 
  str_replace("LOS CERROS EL VERJEL", "LOS CERROS EL VERGEL") %>% 
  str_replace("CAYCEDO", "CAICEDO") %>% 
  str_replace("VALDES", "VALDÉS") %>% 
  str_replace("CERRO EL VOLADOR", "B. CERRO EL VOLADOR") %>% 
  str_replace("MOSCU", "MOSCÚ") %>% 
  str_replace("JOSELA", "JOSÉ LA") %>%
  str_replace("JOSE", "JOSÉ") %>% 
  str_replace("EL YOLOMBO", "YOLOMBO") %>% 
  str_replace("PIEDRAS BLANCAS", "PIEDRAS BLANCAS - MATASANO") %>% 
  str_replace("BASILIA", "BRASILIA") %>% 
  str_replace("VILLA TINA", "VILLATINA") %>% 
  str_replace("LILIAM", "LILLIAM") %>% 
  str_replace("BOLIVAR", "BOLÍVAR") %>% 
  str_replace("CORREGIMIENTO PALMITAS", "PALMITAS SECTOR CENTRAL") %>% 
  str_replace("INES", "INÉS") %>% 
  str_replace("FE", "FÉ") %>% 
  str_replace("LUCIA", "LUCÍA") %>% 
  str_replace("SABIO", "SAVIO") %>% 
  str_replace("BERMEJAL- LOS ÁLAMOS", "BERMEJAL-LOS ÁLAMOS") %>% 
  str_replace("BOLÍVARIANA", "BOLIVARIANA") %>% 
  str_replace("EL NOGAL - LOS ALMENDROS", "EL NOGAL-LOS ALMENDROS") %>% 
  str_replace("JUAN XXIII - LA QUIEBRA", "JUAN XXIII LA QUIEBRA") %>% 
  str_replace("PROGRESO  Nº 2", "EL PROGRESO") %>% 
  str_replace("MARIA", "MARÍA") %>% 
  str_replace("PLAYÓN", "PLAYON") %>% 
  str_replace("EL SOCORRO / LA GABRIELA", "EL SOCORRO") %>% 
  str_replace("FÉRRINI", "FERRINI") %>% 
  str_replace("LA CANDE LARIA", "LA CANDELARIA") %>%
  str_replace("EL PLAYON", "PLAYÓN") %>%
  str_replace("IGUANA", "IGUANÁ") %>%
  str_replace("MARÍA CANO - CARAMBOLAS", "MARÍA CANO-CARAMBOLAS") %>%
  str_replace("DE ABURRA", "DEL ABURRÁ") %>%
  str_replace("ALTAVISTA CENTRAL", "ALTAVISTA SECTOR CENTRAL") %>%
  str_replace("SECTOR CENTRAL", "CENTRO ADMINISTRATIVO") %>%
  str_replace("ALTAVISTA CENTRO ADMINISTRATIVO", "ALTAVISTA SECTOR CENTRAL") %>%
  str_replace("SANTA ELENA CENTRO ADMINISTRATIVO", "SANTA ELENA SECTOR CENTRAL") %>%
  str_replace("PALMITAS CENTRO ADMINISTRATIVO", "PALMITAS SECTOR CENTRAL") %>%  
  str_replace("PROGRESO", "EL PROGRESO")
  )
```

# Funciones propias

```{r}
# Función para la moda
getmode <- function(v, na.rm = TRUE) {
  if(na.rm == TRUE) {
    v <- v[!is.na(v)]
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
   } else {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
  }
}
```

# Construcción de la base de datos

```{r}
factors <- c("encuesta_calidad.barrio", "encuesta_calidad.comuna")

db_salud <- encuesta_salud %>%
  group_by(encuesta_calidad.barrio, encuesta_calidad.comuna) %>% 
  dplyr::summarize(n = n(),
            discapacidad = sum(discapacidad == 1, na.rm = TRUE)/sum(!is.na(discapacidad), na.rm = TRUE),
            acceso_salud = mean(`encuesta_calidad.p_265`, na.rm = TRUE),
            calidad_salud_1 = sum(`encuesta_calidad.p_266_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_266_1`), na.rm = TRUE),
            calidad_salud_2 = sum(`encuesta_calidad.p_266_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_266_2`), na.rm = TRUE),
            calidad_salud_3 = sum(`encuesta_calidad.p_266_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_266_3`), na.rm = TRUE),
            calidad_salud_4 = sum(`encuesta_calidad.p_266_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_266_4`), na.rm = TRUE),
            calidad_salud_5 = sum(`encuesta_calidad.p_266_5` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_266_5`), na.rm = TRUE),
            morbilidad_30 = sum(`encuesta_calidad.p_324` == 1, na.rm = TRUE)/
              sum(!is.na(`encuesta_calidad.p_324`), na.rm = TRUE),
            motivo_negacion_1 = sum(`encuesta_calidad.p_326_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_1`), na.rm = TRUE),
            motivo_negacion_2 = sum(`encuesta_calidad.p_326_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_2`), na.rm = TRUE),
            motivo_negacion_3 = sum(`encuesta_calidad.p_326_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_3`), na.rm = TRUE),
            motivo_negacion_4 = sum(`encuesta_calidad.p_326_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_4`), na.rm = TRUE),
            motivo_negacion_5 = sum(`encuesta_calidad.p_326_5` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_5`), na.rm = TRUE),
            motivo_negacion_6 = sum(`encuesta_calidad.p_326_6` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_6`), na.rm = TRUE),
            motivo_negacion_7 = sum(`encuesta_calidad.p_326_7` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_7`), na.rm = TRUE),
            motivo_negacion_8 = sum(`encuesta_calidad.p_326_8` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_8`), na.rm = TRUE),
            motivo_negacion_9 = sum(`encuesta_calidad.p_326_9` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_326_9`), na.rm = TRUE),
            conteo_prevencion = median(`encuesta_calidad.p_328`, na.rm = TRUE),
            calidad_prevencion_1 = sum(`encuesta_calidad.p_329_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_329_1`), na.rm = TRUE),
            calidad_prevencion_2 = sum(`encuesta_calidad.p_329_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_329_2`), na.rm = TRUE),
            calidad_prevencion_3 = sum(`encuesta_calidad.p_329_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_329_3`), na.rm = TRUE),
            calidad_prevencion_4 = sum(`encuesta_calidad.p_329_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_329_4`), na.rm = TRUE),
            consulta_medico_general = mean(`encuesta_calidad.p_331`, na.rm = TRUE),
            calidad_med_general_1 = sum(`encuesta_calidad.p_332_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_332_1`), na.rm = TRUE),
            calidad_med_general_2 = sum(`encuesta_calidad.p_332_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_332_2`), na.rm = TRUE),
            calidad_med_general_3 = sum(`encuesta_calidad.p_332_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_332_3`), na.rm = TRUE),
            calidad_med_general_4 = sum(`encuesta_calidad.p_332_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_332_4`), na.rm = TRUE),
            consulta_medico_especialista = mean(`encuesta_calidad.p_334`, na.rm = TRUE),
            calidad_med_especial_1 = sum(`encuesta_calidad.p_335_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_335_1`), na.rm = TRUE),
            calidad_med_especial_2 = sum(`encuesta_calidad.p_335_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_335_2`), na.rm = TRUE),
            calidad_med_especial_3 = sum(`encuesta_calidad.p_335_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_335_3`), na.rm = TRUE),
            calidad_med_especial_4 = sum(`encuesta_calidad.p_335_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_335_4`), na.rm = TRUE),
            consulta_urgencias = mean(`encuesta_calidad.p_337`, na.rm = TRUE),
            calidad_urgencias_1 = sum(`encuesta_calidad.p_338_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_338_1`), na.rm = TRUE),
            calidad_urgencias_2 = sum(`encuesta_calidad.p_338_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_338_2`), na.rm = TRUE),
            calidad_urgencias_3 = sum(`encuesta_calidad.p_338_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_338_3`), na.rm = TRUE),
            calidad_urgencias_4 = sum(`encuesta_calidad.p_338_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_338_4`), na.rm = TRUE),
            hospitalizacion = mean(`encuesta_calidad.p_340`, na.rm = TRUE),
            calidad_hospitalizacion_1 = sum(`encuesta_calidad.p_341_1` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_341_1`), na.rm = TRUE),
            calidad_hospitalizacion_2 = sum(`encuesta_calidad.p_341_2` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_341_2`), na.rm = TRUE),
            calidad_hospitalizacion_3 = sum(`encuesta_calidad.p_341_3` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_341_3`), na.rm = TRUE),
            calidad_hospitalizacion_4 = sum(`encuesta_calidad.p_341_4` == 1, na.rm = TRUE)/sum(!is.na(`encuesta_calidad.p_341_4`), na.rm = TRUE),
            ) %>% ungroup() %>% 
  mutate_all(~replace_na(., 0)) %>% 
  mutate_at(factors, as_factor) %>% 
  filter(encuesta_calidad.barrio != "DESCONOCIDO")

db_salud
```

# Estadística descriptiva


## Medias y cuartiles

Para la discapacidad

```{r}
summary(db_salud)

db_salud %>% 
  group_by(encuesta_calidad.barrio) %>% 
  dplyr::summarize(media = mean(discapacidad), minimo = min(discapacidad), maximo = max(discapacidad)) %>% 
  arrange(desc(maximo))
```

## ¿Cuáles son los barrios con menor representación?

```{r}
db_salud %>% 
  arrange(n) %>% 
  View()
```

Luego de identificar los barrios con pocas observaciones, se asumirá que el muestreo fue realizado correctamente y por lo tanto consideramos inclusive las muestras con 4 observaciones como significativas, por lo que no se alterarán las conclusiones con respecto a los máximos y mínimos por cada variable.

## Análisis de correlación

```{r}
glimpse(db_salud)

salud_cor <- db_salud %>%
  select_if(is.numeric) %>% 
  select(-n) %>%
  .[complete.cases(.),] %>% 
  cor()

corrplot(salud_cor, type = "upper", order = "hclust", tl.col = "black", tl.srt = 45)

# Mapa gigante de correlación con factores y números Inviable por número de variables
# db_salud %>% 
#   select(-encuesta_calidad.barrio, -encuesta_calidad.comuna, -n) %>%
#   ggpairs(aes(alpha = 0.4))

```

### Caso 1 - Sin one-hot encoding

No se identifican correlaciones notorias entre las variables numéricas, se nota que hay ciertas variables con distribuciones marcadas, como el acceso a salud con una función de densidad de probabilidad muy similar a la distribución normal y otras variables con distribuciones con sesgos hacia la izquierda.

### Caso 2 - Con one-hot encoding

>>Pendiente<<

## Escalamiento de datos

```{r}
salud_scaled <- db_salud_complete %>% 
  mutate_at(vars(-n, -encuesta_calidad.barrio, -encuesta_calidad.comuna), scale)
```

# Agrupamiento mediante k-Means
```{r}
clustering_salud <- salud_scaled %>% 
  dplyr::select(-n, -encuesta_calidad.barrio, -encuesta_calidad.comuna)

k_maximo <- 15

wss <- sapply(1:k_maximo, 
              function(k) {
                kmeans(clustering_salud, k, nstart = 10, iter.max = 15 )$tot.withinss
              })

plot(1:k_maximo, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Número de grupos [K]",
     ylab="Total de suma de cuadrados intra-grupos")

k_optimo_kmeans <- 10
k_seleccionado <- 5
```

Para favorecer la interpretabilidad y teniendo en cuenta que no hay agrupamientos incorrectos, se decide utilizar `k_seleccionado` grupos y realizar su análisis descriptivo que permita llegar a conclusiones dicientes de los barrios analizados.

## Agrupamiento con $K$ seleccionado 


```{r}
agrupamiento_kmeans <- kmeans(clustering_salud, centers = k_seleccionado, nstart = 10, iter.max = 15 )
```

## Mapa para el agrupamiento mediante K-means

```{r}
political <- shapefile("Barrio_Vereda/Barrio_Vereda.shp")
Encoding(political@data$NOMBRE) <- "UTF-8"
political$NOMBRE <- political$NOMBRE %>% toupper() %>% str_replace("DE  MESA", "DE MESA")

grupos_barrios <- data.frame(barrio_nombre = db_salud_complete$encuesta_calidad.barrio, grupo = agrupamiento_kmeans$cluster)
nombres_mapa <- data.frame(nombre_barrio = political$NOMBRE)

vector_nombres = c()
vector_grupos = c()

for(nombre_mapa in nombres_mapa$nombre_barrio) {
  grupo <- grupos_barrios[grupos_barrios$barrio_nombre == nombre_mapa, 2][1]
  vector_nombres <- c(vector_nombres, nombre_mapa)
  vector_grupos <- c(vector_grupos, grupo)
}

mapa_grupos <- data.frame(
  nombre_barrio = vector_nombres, 
  grupo = vector_grupos
)

factpal <- colorFactor(rainbow(k_optimo_kmeans), mapa_grupos$grupo)

leaflet(data = political) %>% 
  addTiles() %>% 
  addProviderTiles(providers$OpenStreetMap) %>% 
  addPolygons(fill = TRUE, stroke = TRUE, weight = 2, color = ~factpal(mapa_grupos$grupo), 
              label = as.character(political$NOMBRE),
              popup = as.character(political$NOMBRE)) %>% 
  addLegend("bottomright", colors = "#03F", labels = "Barrios y veredas")
```



# Escritura

```{r, include = F}
write_excel_csv2(db_salud, "databases/db_salud.csv")
write_excel_csv2(db_salud[complete.cases(db_salud),], "databases/db_salud_completecases.csv")
```

